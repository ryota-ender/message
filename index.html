<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>寄せ書き</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Shippori+Mincho:wght@400;600&display=swap");

    :root {
      --wood-1: #6a4a2f;
      --wood-2: #3f2a1a;
      --paper: #fff7ec;
      --paper-shadow: #f0e1cf;
      --ink: #3b2b21;
      --accent: #c86b43;
      --line: #d9c7b1;
      --muted: #7a6454;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--ink);
      background:
        linear-gradient(120deg, rgba(255,255,255,0.08), rgba(0,0,0,0.08)),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0 6px, rgba(0,0,0,0.03) 6px 12px),
        linear-gradient(135deg, var(--wood-1), var(--wood-2));
      font-family: "Shippori Mincho", "Noto Serif JP", serif;
      min-height: 100vh;
    }
    body.modal-open { overflow: hidden; }

    header {
      text-align: center;
      padding: 26px 16px 8px;
    }
    header h1 {
      margin: 0;
      letter-spacing: 0.08em;
      font-size: 28px;
      color: #f8efe6;
      text-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }

    main {
      max-width: 560px;
      margin: 0 auto;
      padding: 10px 16px 32px;
    }

    .board {
      background: linear-gradient(180deg, var(--paper) 0%, var(--paper-shadow) 100%);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      border: 2px solid #d1b899;
      position: relative;
    }
    .board:before {
      content: "";
      position: absolute;
      inset: 8px;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      pointer-events: none;
    }

    .menu-title {
      font-family: "Klee One", "Noto Serif JP", serif;
      font-size: 17px;
      margin-bottom: 10px;
      letter-spacing: 0.06em;
      text-align: center;
    }

    .menu-list {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .menu-item {
      width: min(360px, 86vw);
      text-align: center;
      font-family: "Klee One", "Noto Serif JP", serif;
      font-size: 18px;
      color: var(--ink);
      background: transparent;
      border: none;
      padding: 10px 12px;
      cursor: pointer;
      position: relative;
    }
    .menu-item:after {
      content: \"\";
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 4px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(59,43,33,0.35), transparent);
    }
    .menu-item:hover { color: #2a1f18; }
    .menu-item:active { transform: scale(0.98); }
    .menu-item:focus-visible { outline: 3px solid rgba(200,107,67,0.35); border-radius: 10px; }

    .dish-item {
      width: clamp(220px, 72vw, 320px);
      aspect-ratio: 1 / 1;
      position: relative;
      background: transparent;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.08s ease;
    }
    .dish-item img {
      width: 100%;
      height: 100%;
      display: block;
    }
    .dish-item:hover { transform: translateY(-2px); }
    .dish-item:active { transform: scale(0.98); }
    .dish-item:focus-visible { outline: 3px solid rgba(200,107,67,0.5); border-radius: 50%; }

    .cooking-item {
      cursor: default;
      pointer-events: none;
      filter: saturate(0.95);
    }
    .cooking-item:hover,
    .cooking-item:active {
      transform: none;
    }

    .drink-item {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      margin: 2px 0 6px;
    }
    .drink-item img {
      width: min(160px, 42vw);
      height: auto;
      display: block;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,0.15));
    }

    .dish-name {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      font-family: "Klee One", "Noto Serif JP", serif;
      font-size: clamp(16px, 4.6vw, 22px);
      color: var(--ink);
      text-shadow: 0 1px 6px rgba(255,255,255,0.8);
      pointer-events: none;
    }

    .dish-item--small {
      width: 100%;
      max-width: 240px;
      justify-self: center;
    }

    .hint { font-size: 12px; color: var(--muted); text-align: center; }
    .hint.error { color: #b2362e; }
    .hidden { display: none; }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    #welcome {
      font-size: 16px;
      font-family: "Klee One", "Noto Serif JP", serif;
    }
    .panel-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .field {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px 0;
    }
    label {
      width: 100%;
      font-size: 13px;
      color: var(--muted);
    }
    input, button {
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      font-family: "Klee One", "Noto Serif JP", serif;
    }
    input {
      border: 1px solid #d8cbbb;
      flex: 1;
      color: #2b2b2b;
      background: #fff;
    }
    button.action {
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px 16px;
      box-shadow: 0 6px 12px rgba(200,107,67,0.2);
    }
    button.action:hover { opacity: 0.92; }

    .error { color: #b2362e; margin-top: 8px; font-size: 13px; }

    .sender-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }
    .modal.hidden { display: none; }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
    }
    .modal-card {
      position: relative;
      width: min(520px, 92vw);
      background: linear-gradient(180deg, var(--paper) 0%, var(--paper-shadow) 100%);
      border-radius: 16px;
      padding: 16px;
      border: 2px solid #d1b899;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      color: var(--ink);
    }
    .modal-card:before {
      content: "";
      position: absolute;
      inset: 8px;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      pointer-events: none;
    }
    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-family: "Klee One", "Noto Serif JP", serif;
    }
    .modal-title {
      font-size: 17px;
      letter-spacing: 0.06em;
    }
    .modal-close {
      background: transparent;
      border: none;
      color: var(--ink);
      font-size: 22px;
      cursor: pointer;
      padding: 4px 8px;
    }
    .modal-name {
      font-family: "Klee One", "Noto Serif JP", serif;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .message-text {
      background: #fff;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 12px;
      font-size: 15px;
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: 45vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body>
  <header>
    <h1>Congratulations Message</h1>
  </header>

  <main>
    <section class="board" id="loginPanel">
      <div class="menu-title">Thank you for everything!</div>
      <div class="menu-list" id="menuList"></div>
      <div class="hint">名前をタップしてパスワードを入力してください</div>
      <div class="hint" id="loadStatus" role="status"></div>
    </section>

    <section class="board hidden" id="messagesPanel" style="margin-top:18px;">
      <div class="panel-head">
        <div id="welcome"></div>
      </div>
      <div class="menu-title">メッセージを送ってくれた人</div>
      <div class="sender-list" id="messagesList"></div>
      <div class="panel-footer">
        <button class="action" id="logoutBtn">名前一覧へ戻る</button>
      </div>
    </section>
  </main>

  <div class="modal hidden" id="passwordModal" aria-hidden="true">
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">名前</div>
        <button class="modal-close" id="modalClose" aria-label="閉じる">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-name" id="modalName"></div>
        <div class="field">
          <label for="modalPassword">パスワード</label>
          <input id="modalPassword" type="password" placeholder="0000" />
        </div>
        <div class="error hidden" id="modalError">名前またはパスワードが違います。</div>
      </div>
      <div class="modal-actions">
        <button class="action" id="modalLoginBtn">ログイン</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="messageModal" aria-hidden="true">
    <div class="modal-backdrop" id="messageBackdrop"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="messageTitle">
      <div class="modal-head">
        <div class="modal-title" id="messageTitle">メッセージ</div>
        <button class="modal-close" id="messageClose" aria-label="閉じる">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-name" id="messageFrom"></div>
        <div class="message-text" id="messageBody"></div>
      </div>
      <div class="modal-actions">
        <button class="action" id="messageOk">閉じる</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwUGXYP1pCfRr4kbGyfwPiQDCyqZDX9wQ8GNjCSc7n9-_sfin9WWKh29B_ZKYhSza6Y/exec";

    let guestPasswords = {};
    let memberNames = [];
    let messagesByRecipient = {};
    let loadError = false;

    const menuList = document.getElementById("menuList");
    const loginPanel = document.getElementById("loginPanel");
    const messagesPanel = document.getElementById("messagesPanel");
    const messagesList = document.getElementById("messagesList");
    const welcome = document.getElementById("welcome");
    const logoutBtn = document.getElementById("logoutBtn");
    const loadStatus = document.getElementById("loadStatus");

    const modal = document.getElementById("passwordModal");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalClose = document.getElementById("modalClose");
    const modalName = document.getElementById("modalName");
    const modalPassword = document.getElementById("modalPassword");
    const modalLoginBtn = document.getElementById("modalLoginBtn");
    const modalError = document.getElementById("modalError");

    const messageModal = document.getElementById("messageModal");
    const messageBackdrop = document.getElementById("messageBackdrop");
    const messageClose = document.getElementById("messageClose");
    const messageOk = document.getElementById("messageOk");
    const messageFrom = document.getElementById("messageFrom");
    const messageBody = document.getElementById("messageBody");

    let selectedName = null;

    function setLoadStatus(message, isError) {
      if (!loadStatus) {
        return;
      }
      loadStatus.textContent = message;
      loadStatus.classList.toggle("error", Boolean(isError));
    }

    function normalizeMembers(raw) {
      if (!raw) {
        return [];
      }
      let list = [];
      if (Array.isArray(raw)) {
        list = raw;
      } else if (Array.isArray(raw.members)) {
        list = raw.members;
      } else {
        return [];
      }

      if (list.length && Array.isArray(list[0])) {
        return list.map((row) => ({
          name: String(row[0] || "").trim(),
          password: String(row[1] || "").trim()
        })).filter((item) => item.name);
      }

      return list.map((item) => {
        const nameValue = item.name || item["名前"] || item["ゲスト名"] || "";
        const passwordValue = item.password || item.pass || item["パスワード"] || "";
        return {
          name: String(nameValue).trim(),
          password: String(passwordValue).trim()
        };
      }).filter((item) => item.name);
    }

    function normalizeMessages(raw) {
      if (!raw) {
        return [];
      }
      let list = [];
      if (Array.isArray(raw)) {
        list = raw;
      } else if (Array.isArray(raw.messages)) {
        list = raw.messages;
      } else {
        return [];
      }

      if (list.length && Array.isArray(list[0])) {
        return list.map((row) => ({
          to: String(row[0] || "").trim(),
          from: String(row[1] || "").trim(),
          message: String(row[2] || "").trim()
        })).filter((item) => item.to && item.from && item.message);
      }

      return list.map((item) => {
        const toValue = item.to || item.toName || item["宛先"] || item["宛先名"] || "";
        const fromValue = item.from || item.fromName || item["差出人"] || item["送信者"] || item["送信者名"] || "";
        const messageValue = item.message || item.text || item["メッセージ"] || item["本文"] || "";
        return {
          to: String(toValue).trim(),
          from: String(fromValue).trim(),
          message: String(messageValue).trim()
        };
      }).filter((item) => item.to && item.from && item.message);
    }

    function buildMessagesMap(messages) {
      return messages.reduce((acc, item) => {
        if (!acc[item.to]) {
          acc[item.to] = [];
        }
        acc[item.to].push(item);
        return acc;
      }, {});
    }

    async function loadData() {
      setLoadStatus("データを読み込み中...");
      try {
        const response = await fetch(GAS_URL, { method: "GET" });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const raw = await response.json();
        const members = normalizeMembers(raw);
        const messages = normalizeMessages(raw);
        guestPasswords = members.reduce((acc, member) => {
          acc[member.name] = member.password || "";
          return acc;
        }, {});
        memberNames = members.map((member) => member.name);
        messagesByRecipient = buildMessagesMap(messages);
        loadError = false;
        if (!members.length) {
          setLoadStatus("名前一覧が読み込めませんでした。", true);
        } else {
          setLoadStatus("");
        }
      } catch (error) {
        loadError = true;
        messagesByRecipient = {};
        guestPasswords = {};
        memberNames = [];
        setLoadStatus("データの読み込みに失敗しました。", true);
      }
      renderMenu();
    }

    function setBodyModal(open) {
      if (open) {
        document.body.classList.add("modal-open");
      } else {
        document.body.classList.remove("modal-open");
      }
    }

    function openPasswordModal(name) {
      selectedName = name;
      modalName.textContent = name;
      modalPassword.value = "";
      modalError.classList.add("hidden");
      modal.classList.remove("hidden");
      modal.setAttribute("aria-hidden", "false");
      setBodyModal(true);
      modalPassword.focus();
    }

    function closePasswordModal() {
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
      setBodyModal(false);
    }

    function openMessageModal(from, message) {
      messageFrom.textContent = `${from} さんより`;
      messageBody.textContent = message;
      messageModal.classList.remove("hidden");
      messageModal.setAttribute("aria-hidden", "false");
      setBodyModal(true);
    }

    function closeMessageModal() {
      messageModal.classList.add("hidden");
      messageModal.setAttribute("aria-hidden", "true");
      setBodyModal(false);
    }

    function createDishButton(name, onClick, small, index) {
      const dishImages = [
        "images/dish.png",
        "images/dish2.png",
        "images/dish3.png",
        "images/dish4.png",
        "images/dish5.png"
      ];
      const imageSrc = dishImages[index % dishImages.length];
      const btn = document.createElement("button");
      btn.className = small ? "dish-item dish-item--small" : "dish-item";
      btn.type = "button";
      btn.setAttribute("aria-label", name);
      btn.innerHTML = `
        <img src="${imageSrc}" alt="" aria-hidden="true" />
        <span class="dish-name">${name}</span>
      `;
      btn.addEventListener("click", onClick);
      return btn;
    }

    function createCookingCard(index, small) {
      const cookingImages = [
        "images/cooking.png",
        "images/cooking2.png",
        "images/cooking3.png",
        "images/cooking4.png",
        "images/cooking5.png",
        "images/cooking6.png",
        "images/cooking7.png",
        "images/cooking8.png",
        "images/cooking9.png",
        "images/cooking10.png",
        "images/cooking11.png"
      ];
      const imageSrc = cookingImages[index % cookingImages.length];
      const card = document.createElement("div");
      card.className = `${small ? "dish-item dish-item--small" : "dish-item"} cooking-item`;
      card.setAttribute("aria-hidden", "true");
      card.innerHTML = `
        <img src="${imageSrc}" alt="" aria-hidden="true" />
      `;
      return card;
    }

    function createDrinkCard() {
      const card = document.createElement("div");
      card.className = "drink-item";
      card.setAttribute("aria-hidden", "true");
      card.innerHTML = `
        <img src="images/drink.png" alt="" aria-hidden="true" />
      `;
      return card;
    }

    function createMenuButton(name, onClick) {
      const btn = document.createElement("button");
      btn.className = "menu-item";
      btn.type = "button";
      btn.textContent = name;
      btn.setAttribute("aria-label", name);
      btn.addEventListener("click", onClick);
      return btn;
    }

    function renderMenu() {
      menuList.innerHTML = "";
      const names = memberNames.length ? memberNames : Object.keys(guestPasswords);
      if (!names.length) {
        menuList.innerHTML = "<div class='hint error'>名前一覧がありません。</div>";
        return;
      }
      names.forEach((name) => {
        const btn = createMenuButton(name, () => openPasswordModal(name));
        menuList.appendChild(btn);
      });
    }

    function showMessagesFor(name) {
      messagesList.innerHTML = "";
      if (loadError) {
        messagesList.innerHTML = "<div class='hint error'>メッセージの読み込みに失敗しました。ページを再読み込みしてください。</div>";
        return;
      }
      const items = messagesByRecipient[name] || [];
      if (!items.length) {
        messagesList.innerHTML = "<div class='hint'>メッセージはまだありません。</div>";
        return;
      }
      let dishIndex = 0;
      let cookingIndex = 0;
      items.forEach((item, index) => {
        const from = item.from;
        const message = item.message;
        const dishButton = createDishButton(from, () => openMessageModal(from, message), true, dishIndex);
        const cookingCard = createCookingCard(cookingIndex, true);
        if (index % 2 === 0) {
          messagesList.appendChild(dishButton);
          messagesList.appendChild(cookingCard);
        } else {
          messagesList.appendChild(cookingCard);
          messagesList.appendChild(dishButton);
        }
        dishIndex += 1;
        cookingIndex += 1;
        const isLast = index === items.length - 1;
        if (!isLast && (index + 1) % 2 === 0) {
          messagesList.appendChild(createDrinkCard());
        }
      });
    }

    function attemptLogin() {
      const pass = modalPassword.value.trim();
      const expected = selectedName ? guestPasswords[selectedName] : null;

      if (selectedName && pass === expected) {
        modalError.classList.add("hidden");
        closePasswordModal();
        loginPanel.classList.add("hidden");
        messagesPanel.classList.remove("hidden");
        welcome.textContent = `${selectedName} さんへのメッセージ`;
        showMessagesFor(selectedName);
        window.scrollTo({ top: 0, behavior: "smooth" });
      } else {
        modalError.classList.remove("hidden");
      }
    }

    modalLoginBtn.addEventListener("click", attemptLogin);
    modalPassword.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        attemptLogin();
      }
    });
    modalBackdrop.addEventListener("click", closePasswordModal);
    modalClose.addEventListener("click", closePasswordModal);

    messageBackdrop.addEventListener("click", closeMessageModal);
    messageClose.addEventListener("click", closeMessageModal);
    messageOk.addEventListener("click", closeMessageModal);

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        if (!modal.classList.contains("hidden")) {
          closePasswordModal();
        } else if (!messageModal.classList.contains("hidden")) {
          closeMessageModal();
        }
      }
    });

    logoutBtn.addEventListener("click", () => {
      messagesPanel.classList.add("hidden");
      loginPanel.classList.remove("hidden");
      selectedName = null;
    });

    loadData();
  </script>
</body>
</html>
